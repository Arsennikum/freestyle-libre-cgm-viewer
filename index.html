<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glucose Level Tracker</title>
    <!-- Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.2/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .upload-section {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .upload-section:hover {
            border-color: #4a90e2;
            background-color: #f8f9fa;
        }
        .file-input {
            display: none;
        }
        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background-color: #4a90e2;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-label:hover {
            background-color: #357abd;
        }
        .file-name {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .chart-container {
            width: 100%;
            height: 500px;
            margin-top: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .results {
            /*display: none; !* Hide raw data by default *!*/
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            background-color: #f9f9f9;
            max-height: 300px;
            overflow-y: auto;
        }
        .parse-btn {
            padding: 12px 24px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .parse-btn:hover {
            background-color: #218838;
        }
        .parse-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .download-btn {
            background-color: #17a2b8;
        }
        .download-btn:hover {
            background-color: #138496;
        }
        h2 {
            color: #2c3e50;
            margin-top: 0;
        }
        .instructions {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .instructions h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
        }
        .instructions ol, .instructions ul {
            margin-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
        .example-files {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .download-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 5px;
            transition: background-color 0.3s;
        }
        .download-link:hover {
            background-color: #0056b3;
        }
        .collapsible {
            background-color: #ffffff;
            color: #333;
            cursor: pointer;
            padding: 12px;
            width: 100%;
            border: 1px solid #ddd;
            text-align: left;
            outline: none;
            font-size: 16px;
            border-radius: 4px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }
        .collapsible:hover, .collapsible.active {
            background-color: #f1f1f1;
        }
        .collapsible:after {
            content: '\25B6';
            font-weight: bold;
            float: right;
            transition: transform 0.3s;
        }
        .collapsible.active:after {
            transform: rotate(90deg);
        }
        .content {
            padding: 0 15px;
            display: none;
            overflow: hidden;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .content.show {
            display: block;
            padding: 15px;
        }
        .prompt-box {
            background-color: #f4f4f4;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            border-radius: 0 4px 4px 0;
        }
        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #666;
            padding: 60px 20px;
        }
        .chart-placeholder h3 {
            margin: 0 0 15px 0;
            color: #4a90e2;
            font-size: 24px;
        }
        .chart-placeholder p {
            margin: 0;
            line-height: 1.5;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <!-- GitHub Corner -->
    <a href="https://github.com/Arsennikum/freestyle-libre-cgm-viewer" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#4a90e2; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>
    <style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

    <div class="container">
        <h1>Glucose Level Tracker</h1>

        <div class="instructions">
            <h3>üìã How to Use This Tool</h3>

            <div class="example-files">
                <h4>üöÄ Quick Start - Download Example Files:</h4>
                <p>Try the app with sample data:</p>
                <a href="example_glucose.csv" download class="download-link">üìä Example Glucose Data</a>
                <a href="notes_example.csv" download class="download-link">üìù Example Notes Data</a>
            </div>

            <button type="button" class="collapsible">üì• How to Export Your Glucose Data from LibreView</button>
            <div class="content">
                <ol>
                    <li>Log in to your <a href="https://www.libreview.com/" target="_blank" rel="noopener">LibreView account</a> using your credentials</li>
                    <li>Navigate to the <strong>Glucose History</strong> section from the top left of the page</li>
                    <li>Click the <strong>"Download Glucose Data"</strong> button at the top right of the Glucose History page</li>
                    <li>Complete the reCAPTCHA confirmation to prove you are not a robot</li>
                    <li>Click the <strong>Download</strong> button in the pop-up window to start downloading your glucose data as a .csv file</li>
                    <li>The .csv file will be saved on your device for analysis</li>
                </ol>
                <p><strong>Note:</strong> This tool supports both <em>mg/dL</em> and <em>mmol/L</em> glucose units. Data in mg/dL will be automatically converted to mmol/L for visualization.</p>
            </div>

            <button type="button" class="collapsible">üìù How to Create Notes CSV from Your Messages</button>
            <div class="content">
                <p>If you track your activities in a messenger app (like Telegram), you can convert them to a structured CSV file using AI:</p>

                <h4>Step 1: Copy your messages</h4>
                <p>Export or copy your daily notes and activities from your messenger app.</p>

                <h4>Step 2: Use this AI prompt</h4>
                <div class="prompt-box">Convert the following messenger messages into **CSV** with the format:
`DD-MM-YYYY HH:MM;note;details`
Use `;` as a delimiter.
Column headers must be:

```
timestamp;note;details
```

**Rules:**
1. If the short summary (`note`) is the same as the full text, leave the `details` field empty.
2. If the message contains a time inside the text, use that time instead of the message timestamp.
3. If the message contains multiple activities, split them into multiple rows. If relative times are given, calculate them.
4. Assume the message is written **at the end of the activity**, unless the wording clearly shows otherwise.
5. Summarize each activity in 2‚Äì3 words for the `note` field, keep the full description in `details`.
6. Output only valid CSV, no explanations.

**Example input:**
```
Alexey S, [6/29/25 9:38 AM]
Workout 15 min (lifting medium-power), calm 10 min, sitting down to eat

Alexey S, [6/29/25 9:38 AM]
Breakfast: Long-cooked oatmeal, hummus, avocado
```

**Example output:**
```
timestamp;note;details
29-06-2025 09:13;Workout;Lifting medium-power
29-06-2025 09:28;Rest;Calm 10 min
29-06-2025 09:38;Breakfast;Long-cooked oatmeal, hummus, avocado
```</div>

                <h4>Step 3: Save as CSV</h4>
                <p>Copy the AI output and save it as a .csv file, then upload it to this tool along with your glucose data.</p>
            </div>
        </div>

        <div class="upload-section">
            <h2>Glucose Data (CSV)</h2>
            <input type="file" id="glucoseFile" class="file-input" accept=".csv">
            <label for="glucoseFile" class="file-label">Choose Glucose Data File</label>
            <div id="glucoseFileName" class="file-name">No file chosen</div>
        </div>

        <div class="upload-section">
            <h2>Notes Data (CSV)</h2>
            <input type="file" id="notesFile" class="file-input" accept=".csv">
            <label for="notesFile" class="file-label">Choose Notes Data File</label>
            <div id="notesFileName" class="file-name">No file chosen</div>
        </div>

        <button id="parseBtn" class="parse-btn" disabled>Parse Files</button>

        <button id="downloadBtn" class="parse-btn" disabled style="background-color: #17a2b8; margin-left: 10px;">Download Joined CSV</button>

        <div class="chart-container" id="chart">
            <div class="chart-placeholder">
                <h3>üìä Glucose Level Chart</h3>
                <p>Upload your glucose data and notes files, then click "Parse Files" to view your interactive chart with glucose trends and activity markers.</p>
            </div>
        </div>
        
        <div class="results">
            <h3>Parsed Data:</h3>
            <pre id="output"></pre>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Handle collapsible sections
        document.addEventListener('DOMContentLoaded', function() {
            const collapsibles = document.getElementsByClassName('collapsible');

            for (let i = 0; i < collapsibles.length; i++) {
                collapsibles[i].addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;

                    if (content.classList.contains('show')) {
                        content.classList.remove('show');
                    } else {
                        content.classList.add('show');
                    }
                });
            }
        });
    </script>
</body>
</html>
